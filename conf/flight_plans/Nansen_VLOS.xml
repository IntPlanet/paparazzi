<!DOCTYPE flight_plan SYSTEM "flight_plan.dtd">

<flight_plan alt="70" ground_alt="10" lat0="82.19" lon0="19.23" max_dist_from_home="3000" name="Nansen SUMO" qfu="180" security_height="60">
  <header>
#include "subsystems/navigation/nav_line.h"
#include "subsystems/datalink/datalink.h"
</header>
  <waypoints>
    <waypoint height="130.0" name="_MAX_ALT" x="143.2" y="-64.1"/>
    <waypoint alt="50.0" name="ship" x="20" y="20"/>
    <waypoint alt="40.0" name="pdown" x="265.0" y="170.9"/>
    <waypoint alt="120.0" name="pup" x="265.0" y="215.6"/>
    <waypoint name="HOME" x="0.0" y="-20.0"/>
    <waypoint alt="80.0" name="1" x="-250.0" y="-300.0"/>
    <waypoint alt="80.0" name="2" x="-250.0" y="300.0"/>
    <waypoint alt="80.0" name="S1" x="500.0" y="-500.0"/>
    <waypoint alt="80.0" name="S2" x="-500.0" y="500.0"/>
    <waypoint name="MOB" x="0.0" y="250.0"/>
    <waypoint alt="80.0" name="STBY" x="265.0" y="-10.7"/>
    <waypoint alt="80.0" name="START" x="0.0" y="-200.0"/>
    <waypoint name="_BASELEG" x="156.1" y="-243.1"/>
    <waypoint alt="50.0" name="AF" x="-203.8" y="24.0"/>
    <waypoint alt="30.0" name="TD" x="0.0" y="0.0"/>
    <waypoint alt="80.0" name="P1" x="265.0" y="64.0"/>
  </waypoints>
  <exceptions>
    <exception cond="estimator_z > WaypointAlt(WP__MAX_ALT)" deroute="circle_standby"/>
    <exception cond="datalink_time > 90" deroute="circle_standby"/>
    <exception cond="10.0 > PowerVoltage()" deroute="circle_standby"/>
  </exceptions>
  <blocks>
    <block name="Wait GPS">
      <while cond="!GpsFixValid()"/>
      <while cond="LessThan(NavBlockTime(), 15)"/>
    </block>
    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 1)"/>
      <call fun="NavSetGroundReferencePosHere()"/>
    </block>
    <block name="start">
      <attitude pitch="20" roll="0" throttle="0.99" until="(estimator_flight_time > 5)" vmode="throttle"/>
      <go wp="START"/>
    </block>
    <block name="circle_standby" strip_button="STBY">
      <circle radius="nav_radius" wp="STBY"/>
    </block>

    <block group="prof_step" name="prof_up_stepped" strip_button="profile up (20m steps)" strip_icon="up_profile_s.png">
      <exception cond="WaypointAlt(WP_pdown) > WaypointAlt(WP_pup)" deroute="circle_standby"/>
        <set value="WaypointAlt(WP_pdown)" var="waypoints[WP_P1].a"/>
        <circle radius="nav_radius" until="NavCircleCount() > 2" wp="P1"/>
      <deroute block="prof_up_stepped_n"/>
    </block>

    <block name="prof_up_stepped_n">
      <exception cond="WaypointAlt(WP_pdown) > WaypointAlt(WP_pup)" deroute="circle_standby"/>
      <for from="1" to="(WaypointAlt(WP_pup)-WaypointAlt(WP_pdown))/20" var="i">
        <set value="WaypointAlt(WP_pdown)+20*$i" var="waypoints[WP_P1].a"/>
        <circle radius="nav_radius" until="NavCircleCount() > 2" wp="P1"/>
      </for>
      <deroute block="prof_down_stepped_n"/>
    </block>

    <block group="prof_step" name="prof_down_stepped" strip_button="profile down (20m steps)" strip_icon="down_profile_s.png">
      <exception cond="WaypointAlt(WP_pdown) > WaypointAlt(WP_pup)" deroute="circle_standby"/>
        <set value="WaypointAlt(WP_pup)" var="waypoints[WP_P1].a"/>
        <circle radius="nav_radius" until="NavCircleCount() > 2" wp="P1"/>
      <deroute block="prof_down_stepped_n"/>
    </block>

    <block name="prof_down_stepped_n">
      <exception cond="WaypointAlt(WP_pdown) > WaypointAlt(WP_pup)" deroute="circle_standby"/>
      <for from="1" to="(WaypointAlt(WP_pup)-WaypointAlt(WP_pdown))/20" var="i">
        <set value="WaypointAlt(WP_pup)-20*$i" var="waypoints[WP_P1].a"/>
        <circle radius="nav_radius" until="NavCircleCount() > 2" wp="P1"/>
      </for>
      <deroute block="prof_up_stepped_n"/>
    </block>

    <block group="prof_smooth" name="prof_up" strip_button="profile up" strip_icon="up_profile.png">
      <set value="WaypointAlt(WP_pup)" var="waypoints[WP_P1].a"/>
      <circle radius="nav_radius" until="stage_time > 0.1" wp="P1"/>
      <circle pitch="1" radius="nav_radius" throttle="0.5" until="(GetPosAlt() - WaypointAlt(WP_P1)) > -5" vmode="throttle" wp="P1"/>
      <circle radius="nav_radius" until="NavCircleCount() > 0.5" wp="P1"/>
      <deroute block="prof_down"/>
    </block>
    <block group="prof_smooth" name="prof_down" strip_button="profile down" strip_icon="down_profile.png">
      <set value="WaypointAlt(WP_pdown)" var="waypoints[WP_P1].a"/>
      <circle radius="nav_radius" until="stage_time > 0.1" wp="P1"/>
      <circle pitch="-1" radius="nav_radius" throttle="0.2" until="5 > (GetPosAlt() - WaypointAlt(WP_P1))" vmode="throttle" wp="P1"/>
      <circle radius="nav_radius" until="NavCircleCount() > 0.5" wp="P1"/>
      <deroute block="prof_up"/>
    </block>
    <block name="Line 1-2">
      <exception cond="datalink_time > 22" deroute="circle_standby"/>
      <call fun="nav_line_init()"/>
      <call fun="nav_line(WP_1, WP_2, nav_radius)"/>
    </block>
    <block group="oneD" name="Oval 1-2" strip_button="Oval (wp 1-2)" strip_icon="oval.png">
      <oval p1="1" p2="2" radius="nav_radius"/>
    </block>
    <block group="twoD" name="Survey S1-S2 NS" strip_button="Survey (wp S1-S2) NS" strip_icon="survey.png">
      <go wp="S1"/>
      <survey_rectangle grid="240" wp1="S1" wp2="S2"/>
    </block>
    <block group="twoD" name="Survey S1-S2 WE" strip_button="Survey (wp S1-S2) WE" strip_icon="survey_we.png">
      <go wp="S1"/>
      <survey_rectangle grid="240" orientation="WE" wp1="S1" wp2="S2"/>
    </block>
    <block name="MOB">
      <call fun="NavSetWaypointHere(WP_MOB)"/>
      <set value="DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <circle radius="nav_radius" wp="MOB"/>
    </block>
    <block group="netland" name="Netland Right AF-TD" strip_button="netr" strip_icon="land-right.png">
      <set value="DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="netland"/>
    </block>
    <block group="netland" name="Netland Left AF-TD" strip_button="netl" strip_icon="land-left.png">
      <set value="-DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="netland"/>
    </block>
    <block name="netland">
      <call fun="nav_compute_baseleg(WP_AF, WP_TD, WP__BASELEG, nav_radius)"/>
      <circle radius="nav_radius" until="NavCircleCount() > 0.5" wp="_BASELEG"/>
      <circle radius="nav_radius" until="NavQdrCloseTo(DegOfRad(baseleg_out_qdr)-(nav_radius/fabs(nav_radius))*10) && 20 > fabs(estimator_z - WaypointAlt(WP__BASELEG))" wp="_BASELEG"/>
    </block>
    <block name="netland_final">
      <go approaching_time="0" from="AF" hmode="route" wp="TD"/>
      <deroute block="netland"/>
    </block>
    <block group="land" name="Land Right AF-TD" strip_button="l-right">
      <set value="DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
    <block group="land" name="Land Left AF-TD" strip_button="l-left">
      <set value="-DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
    <block name="land">
      <call fun="nav_compute_baseleg(WP_AF, WP_TD, WP__BASELEG, nav_radius)"/>
      <circle radius="nav_radius" until="NavCircleCount() > 0.5" wp="_BASELEG"/>
      <circle radius="nav_radius" until="NavQdrCloseTo(DegOfRad(baseleg_out_qdr)-(nav_radius/fabs(nav_radius))*10) && 20 > fabs(estimator_z - WaypointAlt(WP__BASELEG))" wp="_BASELEG"/>
    </block>
    <block name="final">
      <exception cond="ground_alt + 10 > estimator_z" deroute="flare"/>
      <go from="AF" hmode="route" vmode="glide" wp="TD"/>
    </block>
    <block name="flare">
      <go approaching_time="0" from="AF" hmode="route" throttle="0.0" vmode="throttle" wp="TD"/>
      <attitude roll="0.0" throttle="0.0" until="FALSE" vmode="throttle"/>
    </block>
    <block group="downdown" name="down" strip_button="Down" strip_icon="downdown.png">
      <set value="LATERAL_MODE_ROLL" var="lateral_mode"/>
      <set value="V_CTL_MODE_MANUAL" var="v_ctl_mode"/>
      <set value="TRUE" var="h_ctl_disabled"/>
      <set value="(-0.6*MAX_PPRZ)" var="h_ctl_aileron_setpoint"/>
      <set value="(0.9*MAX_PPRZ)" var="h_ctl_elevator_setpoint"/>
      <while cond="(GetPosAlt() > ground_alt + 140)"/>
      <set value="0" var="h_ctl_aileron_setpoint"/>
      <set value="0" var="h_ctl_elevator_setpoint"/>
    </block>
    <block group="downdown" name="down_end" strip_button="DownEnd" strip_icon="downdownend.png">
      <set value="0" var="h_ctl_aileron_setpoint"/>
      <set value="0" var="h_ctl_elevator_setpoint"/>
      <while cond="1.> stage_time"/>
      <set value="FALSE" var="h_ctl_disabled"/>
      <deroute block="circle_standby"/>
    </block>
  </blocks>
</flight_plan>
